<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Game Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .disconnect {
            background-color: #dc3545;
        }
        .disconnect:hover {
            background-color: #c82333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.waiting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .message.ready {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .message.disconnect {
            background-color: #fff3cd;
            color: #856404;
        }
        .message.echo {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .test-controls {
            margin-top: 20px;
        }
        .test-message {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .test-message input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Game Connection Test</h1>
        
        <div class="controls">
            <label for="matchId">Match ID:</label>
            <input type="number" id="matchId" value="1" min="1">
            <button id="connectBtn" onclick="connect()">Connect to Match</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled class="disconnect">Disconnect</button>
        </div>

        <div id="status" class="status disconnected">
            Disconnected
        </div>

        <div class="container">
            <h3>Messages</h3>
            <div id="messages" class="messages"></div>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>

        <div class="container test-controls">
            <h3>Test Message Sending</h3>
            <div class="test-message">
                <input type="text" id="testMessage" placeholder="Enter test message" value='{"action": "test", "data": "hello"}'>
                <button onclick="sendTestMessage()" id="sendBtn" disabled>Send Message</button>
            </div>
            <p><small>Try sending JSON messages to test the echo functionality</small></p>
        </div>
    </div>

    <div class="container">
        <h3>Instructions</h3>
        <ol>
            <li>Make sure your server is running on port 3000</li>
            <li>Enter a match ID (e.g., 1, 2, 3)</li>
            <li>Click "Connect to Match" to join as a player</li>
            <li>Open this page in another tab/window with the same match ID to simulate a second player</li>
            <li>Watch the messages to see the connection flow</li>
            <li>Try sending test messages to see the echo response</li>
        </ol>
    </div>

    <script>
        let ws = null;
        let currentMatchId = null;
        let playerNumber = null;

        function connect() {
            const matchId = document.getElementById('matchId').value;
            if (!matchId) {
                addMessage('error', 'Please enter a match ID');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('error', 'Already connected. Disconnect first.');
                return;
            }

            currentMatchId = matchId;
            const wsUrl = `ws://localhost:3000/ws/game/${matchId}`;
            
            addMessage('info', `Attempting to connect to match ${matchId}...`);
            updateStatus('connecting', 'Connecting...');

            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                addMessage('info', 'WebSocket connection established');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    addMessage('error', `Failed to parse message: ${event.data}`);
                }
            };

            ws.onclose = function(event) {
                addMessage('info', `Connection closed. Code: ${event.code}, Reason: ${event.reason}`);
                updateStatus('disconnected', 'Disconnected');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                ws = null;
                playerNumber = null;
            };

            ws.onerror = function(error) {
                addMessage('error', `WebSocket error: ${error}`);
                updateStatus('disconnected', 'Connection Error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function handleMessage(data) {
            switch(data.type) {
                case 'success':
                    playerNumber = data.playerNumber;
                    addMessage('success', `${data.message} (Player ${data.playerNumber})`);
                    updateStatus('connected', `Connected as Player ${data.playerNumber}`);
                    break;
                case 'error':
                    addMessage('error', data.message);
                    updateStatus('disconnected', 'Connection Failed');
                    break;
                case 'ready':
                    addMessage('ready', data.message);
                    updateStatus('ready', 'Match Ready - Both Players Connected!');
                    break;
                case 'disconnect':
                    addMessage('disconnect', data.message);
                    updateStatus('waiting', 'Waiting for other player...');
                    break;
                case 'echo':
                    addMessage('echo', `Echo response: ${JSON.stringify(data.originalMessage)}`);
                    break;
                default:
                    addMessage('info', `Unknown message type: ${JSON.stringify(data)}`);
            }
        }

        function sendTestMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('error', 'Not connected to server');
                return;
            }

            const message = document.getElementById('testMessage').value;
            if (!message) {
                addMessage('error', 'Enter a message to send');
                return;
            }

            try {
                // Try to parse as JSON to validate
                JSON.parse(message);
                ws.send(message);
                addMessage('info', `Sent: ${message}`);
            } catch (error) {
                // If not valid JSON, wrap it
                const wrappedMessage = JSON.stringify({ message: message });
                ws.send(wrappedMessage);
                addMessage('info', `Sent (auto-wrapped): ${wrappedMessage}`);
            }
        }

        function addMessage(type, message) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateStatus(statusClass, statusText) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${statusClass}`;
            statusDiv.textContent = statusText;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Allow Enter key to send test message
        document.getElementById('testMessage').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendTestMessage();
            }
        });

        // Allow Enter key to connect
        document.getElementById('matchId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('connectBtn').disabled) {
                connect();
            }
        });
    </script>
</body>
</html>